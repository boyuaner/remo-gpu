Metadata-Version: 2.4
Name: gpu-watch
Version: 0.1.0
Summary: Monitor GPUs on all hosts defined in ~/.ssh/config.
Author: Leon
Requires-Python: >=3.9
Description-Content-Type: text/markdown
Provides-Extra: rich
Requires-Dist: rich<14,>=13; extra == "rich"
Provides-Extra: textual
Requires-Dist: textual<0.70,>=0.60; extra == "textual"

# GPU Watch CLI

一个基于 Python 的命令行工具，用于批量监控 `~/.ssh/config` 中所有主机的 GPU 使用情况。脚本会对每台主机执行一次 `nvidia-smi`（或自定义命令），并以表格形式实时刷新结果。

## 特性

- 自动解析 `~/.ssh/config` 及其 `Include` 指令，获取可用主机别名
- 并发执行 SSH 命令，默认最多 8 台同时查询
- 表格实时刷新，展示 GPU 利用率、显存占用与温度
- 自定义刷新间隔、SSH 参数、远程命令及密钥文件
- 一次性模式，方便调试或脚本集成

## 快速开始

1. 确保本地 Python ≥ 3.9 且可运行 `ssh`
2. 主机上必须安装 `nvidia-smi`（NVIDIA 驱动自带），并已配置免密登录
3. 运行脚本：

```bash
python3 gpu_watch.py
```

默认每 5 秒刷新一次，可按 `Ctrl + C` 退出。

## 常用参数

```bash
python3 gpu_watch.py \
  --interval 3 \
  --timeout 8 \
  --hosts gpu-a gpu-b \
  --identity-file ~/.ssh/id_rsa \
  --ssh-option "-o StrictHostKeyChecking=no" \
  --ssh-option "-o UserKnownHostsFile=/dev/null"
```

- `--hosts`: 仅监控指定 Host 别名
- `--interval`: 刷新间隔（秒），默认 5
- `--timeout`: 单次 SSH 命令超时（秒），默认 10
- `--identity-file`: 指定私钥文件，等价于 `ssh -i`
- `--ssh-option`: 其他 SSH 原始参数，可多次传入
- `--remote-command`: 自定义远程查询命令，默认执行 `nvidia-smi`
- `--interval-once`: 只运行一次后退出
- `--no-clear`: 禁用清屏，便于查看更长的输出历史

### Rich / Textual UI（可选）

如需更接近 nvitop 的可视化体验，可根据需要安装 `rich` 或 `textual`：

```bash
pip install rich
python3 gpu_watch.py --ui rich --interval 2

pip install textual
python3 gpu_watch.py --ui textual --interval 2
```

- `rich` 模式：彩色进度条与温度信息，自动刷新；
- `textual` 模式：可滚动的像 nvitop 一样的 TUI，支持 ↑/↓ 滚动、`r` 刷新、`q` 退出。

## 使用 uvx 运行

借助 [uv](https://github.com/astral-sh/uv) 的 `uvx` 子命令，可以在隔离环境中运行脚本而不手动创建虚拟环境：

```bash
# 在项目根目录
uvx --from . gpu-watch --interval 3 --ui plain

# 若需 Rich UI，可顺便拉取依赖
uvx --from . --with rich gpu-watch --ui rich --interval 2

# Textual UI
uvx --from . --with textual gpu-watch --ui textual
```

`uvx --from .` 会使用当前目录作为包来源；通过 `--with rich/textual` 可以在隔离环境中临时安装对应可选依赖。其余 CLI 参数与直接调用 `python3 gpu_watch.py` 完全一致。

## Bash 版本

如果希望以纯 bash 方式运行，可直接执行 `gpu_watch.sh`：

```bash
bash gpu_watch.sh \
  --interval 3 \
  --hosts gpu-a,gpu-b \
  --ssh-option StrictHostKeyChecking=no \
  --ssh-option UserKnownHostsFile=/dev/null
```

- `--ssh-option` 会被转换为 `ssh -o key=value`
- `--once` 仅输出一次结果
- 兼容 macOS 自带 bash 3.2；若已安装 bash 4+，同样可直接运行

## 提示

- 如 `.ssh/config` 使用了通配符（`Host *`），脚本会自动忽略
- 若首次连接提示主机指纹，可通过 `--ssh-option "-o StrictHostKeyChecking=no"` 关闭严格校验（按需使用）
- 对监控频率要求更高时，适当调小 `--interval` 并增大 `--concurrency`

## 贡献

欢迎根据自身环境扩展输出格式、Prometheus 上报、或结合 `watch`/`tmux` 等工具打造个性化监控面板。*** End Patch

